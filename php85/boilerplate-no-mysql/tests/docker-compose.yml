services:
  app:
    restart: 'no'
    image: ${AWS_ECR_DEFAULT_URL}/${PROJECT_NAME}:${AWS_ECR_DEFAULT_TAG_PREFIX}${BITBUCKET_COMMIT}
    depends_on:
      data:
        condition: service_completed_successfully
    ports:
      - 80:80
      - 443:443
    env_file:
      - .env
    environment:
      - APP_MYSQL_HOST=mysql
      - APACHE_LOG_DIR=/var/www/logs
      - DOPPLER_TOKEN=${DOPPLER_DEFAULT_TOKEN}
    volumes_from:
      - data
    healthcheck:
      test: [ "CMD", "curl", "-f", "-k", "https://localhost/test.php" ]
      interval: 15s
      timeout: 3s
      retries: 2
  data:
    restart: 'no'
    image: ubuntu
    volumes:
      - ./tmp-mount:/var/www/html_data